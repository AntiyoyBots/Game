/*
 * server created as part of AntiyoyBots project
 * by pettro98 <ya.skywalker@yandex.ru>
 * 
 * P.S. sorry for this code...
 */

"use strict";

////////////////////////////////////////////////////////////////////////////////
//  IMPORTING NPM MODULES
////////////////////////////////////////////////////////////////////////////////

const express = require("express");
const multipart = require("connect-multiparty");
const fs = require('fs');
const path = require('path');
const favicon = require("serve-favicon");

////////////////////////////////////////////////////////////////////////////////
//	IMPORTING CUSTOM MODULES
////////////////////////////////////////////////////////////////////////////////

const util = require("./util.js");
const botsSub = require("./bots-router.js");
const gameSub = require("./game-router.js");

////////////////////////////////////////////////////////////////////////////////
//  GLOBAL VARIABLES
////////////////////////////////////////////////////////////////////////////////

const app = express();

////////////////////////////////////////////////////////////////////////////////
//  GENERAL REQUEST HANDLERS
////////////////////////////////////////////////////////////////////////////////

app.use(multipart());
app.use(util.logRequest);
app.use(favicon(util.FILES.favicon.path));
app.use("/scripts", express.static(util.DIRS.scriptsPath));

////////////////////////////////////////////////////////////////////////////////
//  GENERAL "GET" REQUEST HANDLERS
////////////////////////////////////////////////////////////////////////////////

app.get("/", getMain);
app.get("/err", getError);  //remove later

////////////////////////////////////////////////////////////////////////////////
//	CUSTOM MIDDLEWARE HANDLERS
////////////////////////////////////////////////////////////////////////////////

app.use("/bots", botsSub());
app.use("/game", gameSub());

app.use(notFound);

////////////////////////////////////////////////////////////////////////////////
//	LAUNCH SERVER
////////////////////////////////////////////////////////////////////////////////

// listen on environment or 5000 port
app.listen(util.PORT, () => {
	util.myLog("Server listening on port " + util.PORT + "!");
});

// listen on standard http port
app.listen(util.HTTP_PORT, () => {
	util.myLog("Server listening on port " + util.HTTP_PORT + "!");
});

////////////////////////////////////////////////////////////////////////////////
//	ADDITIONAL FUNCTIONS
////////////////////////////////////////////////////////////////////////////////

function getMain(req, res, next) {
	res.status(200);
	util.sendAFile(res, next, util.FILES.main);
	util.myLog("sent main page");
};

function getError(req, res, next) {
	res.status(200);
	util.sendAFile(res, next, util.FILES.main);
	util.myLog("sent main (error)");
};

function notFound(req, res, next) {
	res.sendStatus(404);
};